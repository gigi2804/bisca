<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bisca Pro</title>
    <style>
        :root { --table-color: #0d5226; --table-border: #3d2b1f; --card-width: 55px; --card-height: 90px; --avatar-size: 40px; }
        @media (max-width: 768px) { :root { --card-width: 40px; --card-height: 65px; --avatar-size: 32px; } }
        body { font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; height: 100vh; overflow: hidden; display: flex; user-select: none; touch-action: manipulation; }
        
        #app-wrapper { display: flex; width: 100%; height: 100%; }
        #game-area { flex-grow: 1; position: relative; background: radial-gradient(circle, #1a6b35, #051a0a); display: none; overflow: hidden;}
        
        /* SIDEBAR CHAT */
        #chat-sidebar { width: 300px; background: #1a1a1a; border-left: 2px solid #d4af37; display: flex; flex-direction: column; z-index: 1000; transition: 0.3s; }
        
        /* ADATTAMENTO MOBILE - FIX IMPORTANTE PER TASTIERA */
        @media (max-width: 768px) { 
            #app-wrapper { flex-direction: column; } 
            #chat-sidebar { 
                width: 100%; 
                height: 40%; /* Un po' pi√π spazio alla chat */
                border-left: none; border-top: 2px solid #d4af37; 
            } 
            #game-area { height: 60%; } 
            .player-info { padding: 2px 4px !important; font-size: 9px !important; min-width: 60px !important;} 
        }

        #chat-header { padding: 8px; background: #d4af37; color: black; font-weight: bold; text-align: center; font-size: 14px; flex-shrink: 0;}
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 13px; display: flex; flex-direction: column; gap: 6px; }
        
        /* INPUT AREA ROBUSTA */
        #chat-input-area { 
            padding: 8px; background: #222; display: flex; gap: 5px; 
            flex-shrink: 0; /* IMPEDISCE DI SCHIACCIARSI */
            min-height: 45px;
        }
        #chat-input { flex-grow: 1; padding: 8px; border: 1px solid #555; background: #333; color: white; border-radius: 4px; outline:none;}
        #chat-send { width: 40px; background: #d4af37; border: none; cursor: pointer; color: black; font-weight: bold; border-radius: 4px;}
        .msg { padding: 6px 10px; border-radius: 8px; max-width: 85%; word-wrap: break-word; line-height: 1.3; }
        .msg-mine { background: #006400; align-self: flex-end; border-bottom-right-radius: 0; }
        .msg-other { background: #444; align-self: flex-start; border-bottom-left-radius: 0; }
        .msg-name { font-size: 9px; color: #ccc; margin-bottom: 2px; font-weight: bold; }

        #login, #lobby { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(16, 16, 16, 0.98); padding: 30px; border: 2px solid #d4af37; z-index: 2000; text-align: center; border-radius: 15px; width: 85%; max-width: 320px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        input, select { padding: 12px; width: 90%; margin-bottom: 15px; text-align: center; background: #222; color: white; border: 1px solid #555; border-radius: 5px; font-size: 16px;}
        button { padding: 12px; cursor: pointer; background: #d4af37; border: none; font-weight: bold; width: 100%; border-radius: 5px; font-size: 16px; text-transform: uppercase; color: #000; transition: 0.2s;}
        button:active { transform: scale(0.98); }
        
        #felt { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 92%; height: 55%; border: 8px solid #3d2b1f; background: #0d5226; border-radius: 100px; box-shadow: inset 0 0 80px rgba(0,0,0,0.7); }
        .player-seat { position: absolute; width: 100px; height: 90px; transform: translate(-50%, -50%); text-align: center; font-size: 12px; transition: 0.5s; z-index: 10; display: flex; flex-direction: column; align-items: center;}
        .avatar { width: var(--avatar-size); height: var(--avatar-size); background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #666; font-size: 16px; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.5);}
        .active-turn .avatar { border-color: gold; box-shadow: 0 0 15px gold; transform: scale(1.15); }
        .eliminated-player { opacity: 0.5; filter: grayscale(100%); }
        .player-info { background: rgba(0,0,0,0.8); padding: 3px 6px; border-radius: 8px; margin-top: 4px; border: 1px solid #444; color: #ddd; white-space: nowrap;}

        .played-card-slot { position: absolute; width: var(--card-width); height: var(--card-height); transform: translate(-50%, -50%); z-index: 5; transition: 0.3s;}
        .blind-card-display { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); width: calc(var(--card-width) * 0.6); height: calc(var(--card-height) * 0.6); background: white; border: 1px solid black; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 20; }
        .blind-card-display img { width: 100%; height: 100%; }
        .card { width: var(--card-width); height: var(--card-height); background: white; border-radius: 4px; cursor: pointer; box-shadow: 1px 1px 4px rgba(0,0,0,0.6); transition: 0.2s;}
        .card img { width: 100%; height: 100%; object-fit: fill; border-radius: 4px;}
        .card-back { background: repeating-linear-gradient(45deg, #2b3990, #2b3990 5px, #1a235a 5px, #1a235a 10px); border: 2px solid #fff; }

        #my-dashboard { position: absolute; bottom: 0; left:0; width: 100%; height: 110px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: none; z-index: 100;}
        #my-hand { display: flex; gap: 5px; pointer-events: auto; }
        .hand-card:hover { transform: translateY(-20px) scale(1.1); z-index: 200; border: 1px solid gold; }

        #center-status { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 90%; pointer-events: none; z-index: 500; }
        #status-msg { font-size: 16px; font-weight: bold; color: #eee; text-shadow: 0 2px 4px black; background: rgba(0,0,0,0.7); padding: 10px 15px; border-radius: 10px; display: inline-block; line-height: 1.4; border: 1px solid #d4af37;}
        #controls { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 10px 15px; border: 1px solid gold; border-radius:10px; display: none; text-align: center; z-index: 600;}
        #bid-buttons { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;}
        #bid-buttons button { width: 35px; height: 35px; border-radius: 50%; font-size: 16px; margin: 0;}
        
        #btn-pause { position: absolute; top: 10px; right: 10px; z-index: 2000; font-size: 11px; padding: 6px 10px; width: auto; background: rgba(255,255,255,0.1); border: 1px solid #777; color: #ccc; }
        #bonus-display { position: absolute; top: 10px; left: 10px; z-index: 2000; font-size: 11px; padding: 6px 10px; background: rgba(0,0,0,0.7); border-radius: 6px; border: 1px solid #444; color: #fff; font-weight: bold; }
        .bonus-active { color: #00ff00; border-color: #00ff00; }
        .bonus-used { color: #ff4444; border-color: #ff4444; }
        #pause-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; color: gold; font-size: 30px; flex-direction: column; backdrop-filter: blur(5px); }
    </style>
</head>
<body>
    <div id="pause-overlay">PAUSA<br><button style="width:auto; margin-top:20px; font-size:14px;" onclick="togglePause()">RIPRENDI</button></div>
    
    <div id="app-wrapper">
        <div id="game-area">
            <button id="btn-pause" onclick="togglePause()">PAUSA</button>
            <div id="bonus-display">BONUS: DISPONIBILE üü¢</div>
            <div id="felt">
                <div id="center-status"><div id="status-msg">TAVOLO PRONTO</div></div>
                <div id="seats-container"></div>
            </div>
            <div id="controls">
                <div style="color:#d4af37; margin-bottom:5px; font-size:12px; font-weight:bold;">QUANTE PRESE?</div>
                <div id="bid-buttons"></div>
            </div>
            <div id="my-dashboard"><div id="my-hand"></div></div>
        </div>

        <div id="chat-sidebar" style="display:none;">
            <div id="chat-header">CHAT</div>
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Messaggio..." autocomplete="off">
                <button id="chat-send" onclick="sendChat()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="login">
        <h2 style="color:#d4af37; margin-top:0;">BISCA ONLINE</h2>
        <input id="username" placeholder="Tuo Nome" maxlength="10">
        <input id="roomname" placeholder="Nome Stanza (es. Pizza)" maxlength="15">
        <button onclick="join()">ENTRA</button>
    </div>
    
    <div id="lobby" style="display:none">
        <h3 style="color:#d4af37; margin-top:0;">SALA D'ATTESA</h3>
        <div id="room-title" style="color:#888; font-size:12px; margin-bottom:10px;"></div>
        <div id="lobby-list" style="color:#ccc; margin-bottom:15px; min-height:50px;"></div>
        
        <div id="host-controls" style="display:none; text-align:left; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
            <label>Vite Iniziali:</label>
            <select id="opt-lives">
                <option value="5">5 Vite (Classica)</option>
                <option value="3">3 Vite (Veloce)</option>
            </select>
            <label style="display:flex; align-items:center; gap:10px; margin-top:10px; cursor:pointer;">
                <input type="checkbox" id="opt-blind" style="width:20px; margin:0;"> 
                <span>Modalit√† Cieca (1 Carta)</span>
            </label>
            <button onclick="start()" style="margin-top:15px;">INIZIA PARTITA</button>
        </div>
        <div id="waiting-msg" style="color:#888; font-size:12px; margin-top:10px;">In attesa dell'Host...</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null, isMyTurn = false;
        const ESTENSIONE = ".jpg"; 
        const CARTELLE_LOCALE = "/carte/";
        let isBlindModeActive = false; 
        let currentBlindCards = [];

        socket.on('connect', () => { 
            myId = socket.id; 
            if(localStorage.getItem('bisca_username')) document.getElementById('username').value = localStorage.getItem('bisca_username');
            if(localStorage.getItem('bisca_room')) document.getElementById('roomname').value = localStorage.getItem('bisca_room');
        });

        function sendChat() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(txt) { socket.emit('sendChat', txt); input.value = ''; input.focus(); }
        }
        document.getElementById('chat-input').addEventListener("keypress", (e) => { if (e.key === "Enter") sendChat(); });

        socket.on('chatMessage', (data) => {
            const chatBox = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = (data.id === myId) ? 'msg msg-mine' : 'msg msg-other';
            div.innerHTML = `<div class="msg-name">${data.name}</div>${data.text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        function renderCard(c, isHand, idx, isBack = false) {
            const div = document.createElement('div');
            div.className = isHand ? 'card hand-card' : 'card table-card';
            if (isBack) {
                div.className += ' card-back';
            } else {
                const sMap = {'denari':'d', 'coppe':'c', 'spade':'s', 'bastoni':'b'};
                const imgSrc = `${CARTELLE_LOCALE}${c.value}${sMap[c.suit]}${ESTENSIONE}`;
                div.innerHTML = `<img src="${imgSrc}" onerror="this.style.display='none'"><div class="card-css" style="display:none;color:black;padding-top:20px;font-size:10px;">${c.value}<br>${c.suit}</div>`;
            }
            if(isHand) div.onclick = () => play(idx, c);
            return div;
        }

        function join() {
            const name = document.getElementById('username').value.trim();
            const roomName = document.getElementById('roomname').value.trim();
            if(!name || !roomName) return alert("Inserisci Nome e Stanza!");
            localStorage.setItem('bisca_username', name);
            localStorage.setItem('bisca_room', roomName);
            socket.emit('join', { name: name, roomName: roomName });
            document.getElementById('login').style.display='none'; 
            document.getElementById('lobby').style.display='block';
            document.getElementById('chat-sidebar').style.display='flex';
            document.getElementById('room-title').innerText = "STANZA: " + roomName.toUpperCase();
        }
        
        function start() { 
            const opts = { lives: document.getElementById('opt-lives').value, blindMode: document.getElementById('opt-blind').checked };
            socket.emit('startGame', opts); 
        }
        function togglePause() { socket.emit('togglePause'); }
        function play(idx, c) {
            if(!isMyTurn) return;
            let asso = null;
            if (c && c.suit==='denari' && c.value===1) { asso = confirm("Asso Alto (OK) o Basso (Annulla)?") ? 'HIGH' : 'LOW'; } 
            socket.emit('playCard', { cardIndex: idx, assoChoice: asso });
        }

        socket.on('backToLobby', () => {
            alert("Partita finita! Ritorno alla Lobby.");
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('lobby').style.display = 'block';
            isBlindModeActive = false; currentBlindCards = [];
            document.getElementById('my-hand').innerHTML = '';
            document.getElementById('seats-container').innerHTML = '';
        });

        socket.on('blindRoundStart', (allCards) => {
            isBlindModeActive = true; currentBlindCards = allCards; 
            switchToGameView();
            const handDiv = document.getElementById('my-hand'); handDiv.innerHTML='';
            handDiv.appendChild(renderCard(null, true, 0, true)); 
        });
        socket.on('blindRoundInfo', (allCards) => { isBlindModeActive = true; currentBlindCards = allCards; });
        socket.on('clearBlindCards', () => { isBlindModeActive = false; currentBlindCards = []; });

        socket.on('reconnectData', d => {
            switchToGameView();
            updateBonusUI(d.bonusInfo);
            if(d.gameState==="PAUSED") document.getElementById('pause-overlay').style.display='flex';
            renderTable(d.players); updateHand(d.hand); updateTable(d.table); updateTurn(d.isMyTurn, d.phase, d.roundCards);
        });

        function switchToGameView() {
            document.getElementById('login').style.display='none'; 
            document.getElementById('lobby').style.display='none';
            document.getElementById('game-area').style.display='block';
            document.getElementById('btn-pause').style.display='block';
            document.getElementById('bonus-display').style.display='block';
            document.getElementById('chat-sidebar').style.display='flex';
        }

        socket.on('updatePlayers', d => {
            const list = d.list || d; 
            document.getElementById('lobby-list').innerHTML = list.map(x=>x.name).join('<br>');
            if (d.isHost) { document.getElementById('host-controls').style.display = 'block'; document.getElementById('waiting-msg').style.display = 'none'; } 
            else { document.getElementById('host-controls').style.display = 'none'; document.getElementById('waiting-msg').style.display = 'block'; }
            renderTable(list);
        });

        socket.on('updateBonus', d => updateBonusUI(d));
        function updateBonusUI(d) {
            const el = document.getElementById('bonus-display');
            if (!d.used) { el.innerHTML = "BONUS: DISPONIBILE üü¢"; el.className = "bonus-active"; }
            else { el.innerHTML = `BONUS: USATO DA ${d.by ? d.by.toUpperCase() : '?'} üî¥`; el.className = "bonus-used"; }
        }

        socket.on('updateHand', h => {
            if(isBlindModeActive) return; 
            switchToGameView();
            const div = document.getElementById('my-hand'); div.innerHTML='';
            h.forEach((c, i) => div.appendChild(renderCard(c, true, i)));
        });
        
        socket.on('tableUpdate', t => updateTable(t));
        socket.on('turnUpdate', d => updateTurn(d.playerId===myId, d.phase, d.roundCards));
        socket.on('gamePaused', p => document.getElementById('pause-overlay').style.display = p ? 'flex':'none');
        socket.on('statusMsg', m => document.getElementById('status-msg').innerHTML = m);
        
        socket.on('trickResult', m => { 
            const el = document.getElementById('status-msg'); el.innerHTML=m; el.style.color='gold'; el.style.borderColor='gold';
            setTimeout(()=> { el.style.color='#eee'; el.style.borderColor='#d4af37'; }, 2000); 
        });
        socket.on('gameOver', m => { alert(m); });

        function updateTable(cards) {
            document.querySelectorAll('.played-card-slot').forEach(e=>e.innerHTML='');
            cards.forEach(x => {
                const slot = document.getElementById('slot-'+x.playerId);
                if(slot) {
                    const el = renderCard(x.card, false);
                    if(x.isAssoHigh) el.innerHTML+=`<div class="asso-badge">${x.isAssoHigh?'A':'v'}</div>`;
                    slot.appendChild(el);
                }
            });
        }

        function updateTurn(isMine, phase, count) {
            isMyTurn = isMine;
            document.getElementById('my-hand').style.opacity = isMine ? 1 : 0.6;
            const c = document.getElementById('controls');
            if(isMine && phase==='BIDDING') {
                c.style.display='block'; const b=document.getElementById('bid-buttons'); b.innerHTML='';
                for(let i=0; i<=(count||5); i++) {
                    let btn = document.createElement('button'); btn.innerText=i;
                    btn.onclick = () => { socket.emit('placeBid', i); }
                    b.appendChild(btn);
                }
            } else c.style.display='none';
            document.querySelectorAll('.player-seat').forEach(s => s.classList.remove('active-turn'));
        }

        function renderTable(players) {
            const con = document.getElementById('seats-container'); con.innerHTML='';
            const myName = document.getElementById('username').value;
            let idx = players.findIndex(p=>p.name===myName); if(idx===-1) idx=0;
            const ordered = []; for(let i=0; i<players.length; i++) ordered.push(players[(idx+i)%players.length]);

            ordered.forEach((p, i) => {
                const deg = 90 + (i * (360/players.length));
                const rad = deg * (Math.PI/180);
                const cx = 50 + 42*Math.cos(rad), cy = 50 + 40*Math.sin(rad); 
                
                const div = document.createElement('div');
                const deadClass = p.lives <= 0 ? 'eliminated-player' : '';
                const activeClass = p.id===window.activeId ? 'active-turn' : '';
                
                div.className = `player-seat ${activeClass} ${deadClass}`;
                div.style.left=cx+'%'; div.style.top=cy+'%';
                div.setAttribute('data-playerid', p.id); 
                
                let scommessa = p.lastBid !== null ? p.lastBid : '-';
                let prese = p.lastWon;
                let stats = p.lives > 0 
                    ? `‚ù§Ô∏è${p.lives} <span style="color:#ffff00">D:${scommessa}</span> <span style="color:#00ff00">F:${prese}</span>` 
                    : `üíÄ OUT`;
                
                let blindHTML = '';
                if (isBlindModeActive && currentBlindCards.length > 0) {
                    const blindInfo = currentBlindCards.find(c => c.id === p.id);
                    if (blindInfo && blindInfo.card && p.id !== myId && p.lives > 0) {
                        const sMap = {'denari':'d', 'coppe':'c', 'spade':'s', 'bastoni':'b'};
                        const src = `${CARTELLE_LOCALE}${blindInfo.card.value}${sMap[blindInfo.card.suit]}${ESTENSIONE}`;
                        blindHTML = `<div class="blind-card-display"><img src="${src}"></div>`;
                    }
                }

                div.innerHTML = `<div class="avatar">${p.name[0]}</div>
                                 ${blindHTML}
                                 <div class="player-info"><div style="color:#fff; font-weight:bold;">${p.name}</div>${stats}</div>`;
                
                const sx = 50 + 20*Math.cos(rad), sy = 50 + 20*Math.sin(rad);
                const slot = document.createElement('div'); slot.id='slot-'+p.id; slot.className='played-card-slot';
                slot.style.left=sx+'%'; slot.style.top=sy+'%';

                con.appendChild(div); con.appendChild(slot);
            });
        }
    </script>
</body>
</html>