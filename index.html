<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bisca Pro</title>
    <style>
        :root { --table-color: #0d5226; --table-border: #3d2b1f; --card-width: 60px; --card-height: 96px; --avatar-size: 45px; }
        @media (max-width: 768px) { :root { --card-width: 35px; --card-height: 56px; --avatar-size: 28px; } }

        body { font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; height: 100vh; height: 100dvh; width: 100%; overflow: hidden; display: flex; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        #app-wrapper { display: flex; width: 100%; height: 100%; }
        #game-area { flex-grow: 1; position: relative; background: radial-gradient(circle, #1a6b35, #051a0a); display: none; overflow: hidden; }
        #chat-sidebar { width: 300px; background: #1a1a1a; border-left: 2px solid #d4af37; display: flex; flex-direction: column; z-index: 1000; }
        @media (max-width: 768px) { #app-wrapper { flex-direction: column; } #game-area { height: 55%; width: 100%; } #chat-sidebar { width: 100%; height: 45%; border-left: none; border-top: 2px solid #d4af37; } .player-info { padding: 1px 3px !important; } }

        #chat-header { padding: 5px; background: #d4af37; color: black; font-weight: bold; text-align: center; font-size: 12px; flex-shrink: 0;}
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 13px; display: flex; flex-direction: column; gap: 6px; background: #111;}
        #chat-input-area { padding: 8px; background: #222; display: flex; gap: 5px; flex-shrink: 0; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        #chat-input { flex-grow: 1; padding: 10px; border: 1px solid #555; background: #333; color: white; border-radius: 4px; outline:none; font-size: 16px; }
        #chat-send { width: 50px; background: #d4af37; border: none; cursor: pointer; color: black; font-weight: bold; border-radius: 4px; font-size: 18px;}
        .msg { padding: 6px 10px; border-radius: 8px; max-width: 85%; word-wrap: break-word; line-height: 1.3; }
        .msg-mine { background: #006400; align-self: flex-end; border-bottom-right-radius: 0; }
        .msg-other { background: #444; align-self: flex-start; border-bottom-left-radius: 0; }
        .msg-name { font-size: 10px; color: #aaa; margin-bottom: 2px; font-weight: bold; }

        #login, #lobby { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(16, 16, 16, 0.98); padding: 30px; border: 2px solid #d4af37; z-index: 2000; text-align: center; border-radius: 15px; width: 85%; max-width: 320px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        #lobby { padding: 20px; max-height: 80vh; overflow-y: auto; }
        @media (max-width: 768px) { #lobby { top: auto; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-height: 50vh; } }

        #asso-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        #asso-box { background: #222; border: 2px solid #d4af37; border-radius: 15px; padding: 20px; text-align: center; width: 80%; max-width: 300px; box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); }
        .asso-btn { width: 100%; padding: 15px; margin: 10px 0; font-size: 18px; font-weight: bold; border-radius: 8px; cursor: pointer; border: none; transition: 0.2s; }
        .btn-high { background: #d4af37; color: black; }
        .btn-low { background: #444; color: white; border: 1px solid #777; }
        .btn-high:active, .btn-low:active { transform: scale(0.95); }

        input, select { padding: 12px; width: 90%; margin-bottom: 15px; text-align: center; background: #222; color: white; border: 1px solid #555; border-radius: 5px; font-size: 16px;}
        button { padding: 12px; cursor: pointer; background: #d4af37; border: none; font-weight: bold; width: 100%; border-radius: 5px; font-size: 16px; text-transform: uppercase; color: #000; transition: 0.2s;}
        button:active { transform: scale(0.98); }
        
        .btn-secondary { background: #444; color: #ccc; border: 1px solid #666; font-size: 12px; padding: 8px; margin-top: 10px; width: auto;}
        .btn-danger { background: #661111; color: white; border: 1px solid #ff4444; width: auto; font-size: 11px; padding: 6px 10px; position: absolute; top: 5px; left: 5px; z-index: 2000; }
        .btn-restart { background: #111166; color: white; border: 1px solid #4444ff; width: auto; font-size: 11px; padding: 6px 10px; position: absolute; top: 35px; right: 5px; z-index: 2000; }
        #btn-pause { position: absolute; top: 5px; right: 5px; z-index: 2000; font-size: 10px; padding: 5px 8px; width: auto; background: rgba(255,255,255,0.1); border: 1px solid #777; color: #ccc; }
        #bonus-display { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); z-index: 2000; font-size: 10px; padding: 5px 8px; background: rgba(0,0,0,0.7); border-radius: 6px; border: 1px solid #444; color: #fff; font-weight: bold; white-space: nowrap;}
        #btn-music { position: absolute; top: 5px; left: 5px; z-index: 2000; width: 30px; height: 30px; padding: 0; font-size: 16px; border-radius: 50%; background: #333; border: 1px solid #777; color: white; display: none; align-items: center; justify-content: center; }

        .bonus-active { color: #00ff00; border-color: #00ff00; }
        .bonus-used { color: #ff4444; border-color: #ff4444; }
        #pause-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; color: gold; font-size: 30px; flex-direction: column; backdrop-filter: blur(5px); }

        #felt { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 94%; height: 65%; border: 6px solid #3d2b1f; background: #0d5226; border-radius: 80px; box-shadow: inset 0 0 50px rgba(0,0,0,0.7); }
        .player-seat { position: absolute; width: 90px; height: 80px; transform: translate(-50%, -50%); text-align: center; font-size: 12px; transition: 0.5s; z-index: 10; display: flex; flex-direction: column; align-items: center;}
        
        .avatar { width: var(--avatar-size); height: var(--avatar-size); background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #666; font-size: 14px; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.5); flex-shrink: 0; }
        
        .active-turn .avatar { border-color: gold; box-shadow: 0 0 15px gold; transform: scale(1.15); }
        .eliminated-player { opacity: 0.5; filter: grayscale(100%); }
        .player-info { background: rgba(0,0,0,0.9); padding: 4px 8px; border-radius: 6px; margin-top: 4px; border: 1px solid #555; color: #fff; white-space: nowrap; font-size: 16px !important; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        @media (max-width: 768px) { .player-seat { width: 70px; height: 60px; } .player-info { font-size: 10px !important; padding: 1px 3px; margin-top: 1px; line-height: 1.1; } }

        .mini-card-container { display: flex; justify-content: center; margin-top: -10px; margin-bottom: 2px; }
        .mini-card { width: 10px; height: 16px; background: repeating-linear-gradient(45deg, #2b3990, #2b3990 2px, #1a235a 2px, #1a235a 4px); border: 1px solid white; border-radius: 2px; margin: 0 1px; box-shadow: 0 1px 2px black; }
        @media (min-width: 769px) { .mini-card { width: 30px; height: 45px; margin: 0 2px; } }

        .played-card-slot { position: absolute; width: var(--card-width); height: var(--card-height); transform: translate(-50%, -50%); z-index: 20; transition: 0.3s;}
        .blind-card-display { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: calc(var(--card-width) * 0.6); height: calc(var(--card-height) * 0.6); background: white; border: 1px solid black; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 20; }
        .blind-card-display img { width: 100%; height: 100%; }
        .card { width: var(--card-width); height: var(--card-height); background: white; border-radius: 4px; cursor: pointer; box-shadow: 1px 1px 4px rgba(0,0,0,0.6); transition: 0.2s;}
        .card img { width: 100%; height: 100%; object-fit: fill; border-radius: 4px;}
        .card-back { background: repeating-linear-gradient(45deg, #2b3990, #2b3990 5px, #1a235a 5px, #1a235a 10px); border: 2px solid #fff; }

        #my-dashboard { position: absolute; bottom: 0; left:0; width: 100%; height: 90px; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 5px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: none; z-index: 100;}
        #my-hand { display: flex; gap: 5px; pointer-events: auto; }
        .hand-card:hover { transform: translateY(-15px) scale(1.1); z-index: 200; border: 1px solid gold; }

        #center-status { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 95%; pointer-events: none; z-index: 500; }
        #status-msg { font-size: 14px; font-weight: bold; color: #eee; text-shadow: 0 2px 4px black; background: rgba(0,0,0,0.8); padding: 8px 12px; border-radius: 10px; display: inline-block; line-height: 1.4; border: 1px solid #d4af37;}
        
        #controls { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 8px 12px; border: 1px solid gold; border-radius:10px; display: none; text-align: center; z-index: 1500; pointer-events: auto;}
        #bid-buttons { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;}
        #bid-buttons button { width: 32px; height: 32px; border-radius: 50%; font-size: 14px; margin: 0;}
        
        #spectator-area { margin-top: 20px; padding-top: 15px; border-top: 1px solid #444; }
        .btn-join { background: #006400; color: white; border: 1px solid #00ff00; padding: 15px; width: 90%; font-size: 14px; margin-top: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .card-css { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background:#eee; color:#000; border:1px solid #999; }
    </style>
</head>
<body>
    <div id="pause-overlay">PAUSA<br><button style="width:auto; margin-top:20px; font-size:14px;" onclick="togglePause()">RIPRENDI</button></div>
    <audio id="bg-music" loop><source src="/music.mp3" type="audio/mpeg"></audio>

    <div id="asso-modal">
        <div id="asso-box">
            <h3 style="color:#d4af37; margin-top:0;">ASSO DI DENARI</h3>
            <p style="color:#ccc; font-size:14px;">Come lo vuoi giocare?</p>
            <button class="asso-btn btn-high" onclick="confirmAsso('HIGH')">ALTO (11)</button>
            <button class="asso-btn btn-low" onclick="confirmAsso('LOW')">BASSO (1)</button>
        </div>
    </div>

    <div id="app-wrapper">
        <div id="game-area">
            <button id="btn-music" onclick="toggleMusic()" style="display:none;">üîá</button>
            <button class="btn-danger" onclick="leaveGame()">ABBANDONA üè≥Ô∏è</button>
            <button class="btn-restart" onclick="voteRestart()">RICOMINCIA üîÑ</button>
            <button id="btn-pause" onclick="togglePause()">PAUSA</button>
            <div id="bonus-display">BONUS: DISPONIBILE üü¢</div>
            <div id="felt">
                <div id="center-status"><div id="status-msg">TAVOLO PRONTO</div></div>
                <div id="seats-container"></div>
            </div>
            <div id="controls">
                <div style="color:#d4af37; margin-bottom:5px; font-size:12px; font-weight:bold;">QUANTE PRESE?</div>
                <div id="bid-buttons"></div>
            </div>
            <div id="my-dashboard"><div id="my-hand"></div></div>
        </div>

        <div id="chat-sidebar" style="display:none; position:relative;">
        <div id="chat-header">CHAT</div>
        <div id="chat-messages"></div>
    
        <div id="chat-input-area" style="position: relative; align-items: center;">
        
        <div id="sticker-menu" style="display:none; position:absolute; bottom:100%; left:0; width:100%; background:#222; border-top:1px solid #d4af37; padding:10px; box-sizing:border-box; flex-wrap:wrap; gap:5px; max-height:150px; overflow-y:auto; z-index:1001;"></div>
        <button id="btn-camera" onclick="document.getElementById('camera-input').click()" style="width: 42px; height: 42px; background: #333; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 20px; padding: 0; flex-shrink: 0; display: flex; align-items: center; justify-content: center; box-sizing: border-box; margin: 0; margin-right: 2px;">üì∑</button>
        <button id="btn-sticker" onclick="toggleStickers()" style="width: 42px; height: 42px; background: #333; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 20px; padding: 0; flex-shrink: 0; display: flex; align-items: center; justify-content: center; box-sizing: border-box; margin: 0;">ü§°</button>
        <input type="text" id="chat-input" placeholder="Scrivi..." autocomplete="off" style="height: 42px; box-sizing: border-box; margin: 0;">
        <button id="chat-send" onclick="sendChat()" style="height: 42px; box-sizing: border-box; margin: 0;">‚û§</button>
    </div>
</div>
</div>
    </div>

    <div id="login">
        <h2 style="color:#d4af37; margin-top:0;">BISCA ONLINE</h2>
        <input id="username" placeholder="Tuo Nome" maxlength="20">
        <input id="roomname" placeholder="Nome Stanza (es. Pizza)" maxlength="15">
        <button onclick="join()">ENTRA</button>
    </div>
    
    <div id="lobby" style="display:none">
        <h3 style="color:#d4af37; margin-top:0;">SALA D'ATTESA</h3>
        <div id="room-title" style="color:#888; font-size:12px; margin-bottom:10px;"></div>
        <div id="lobby-list" style="color:#ccc; margin-bottom:15px; min-height:50px;"></div>
        <div id="spectator-area" style="display:none;">
            <p style="font-size:12px; color:#aaa; margin-bottom:5px;">Sei in modalit√† Spettatore</p>
            <button class="btn-join" onclick="joinGameFromLobby()">UNISCITI ALLA PARTITA üÉè</button>
        </div>
        <div id="host-controls" style="display:none; text-align:left; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-top:15px;">
            <label>Vite Iniziali:</label>
            <select id="opt-lives">
                <option value="5">5 Vite (Classica)</option>
                <option value="3">3 Vite (Veloce)</option>
            </select>
            <label style="display:flex; align-items:center; gap:10px; margin-top:10px; cursor:pointer;">
                <input type="checkbox" id="opt-blind" style="width:20px; margin:0;"> 
                <span>Modalit√† Cieca (1 Carta)</span>
            </label>
            <button onclick="start()" style="margin-top:15px;">INIZIA PARTITA</button>
        </div>
        <div id="waiting-msg" style="color:#888; font-size:12px; margin-top:10px;">In attesa dell'Host...</div>
        <button class="btn-secondary" onclick="changeRoom()">üîô CAMBIA STANZA</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null, isMyTurn = false;
        window.activeId = null; 
        
        const ESTENSIONE = ".jpg"; 
        const CARTELLE_LOCALE = "/carte/";
        let isBlindModeActive = false; 
        let currentBlindCards = [];
        let currentTableState = [];
        let amISpectator = false;
        let pendingCardIndex = null;

        let musicPlaying = false;
        function toggleMusic() {
            const audio = document.getElementById('bg-music');
            const btn = document.getElementById('btn-music');
            if (audio.paused) { audio.volume = 0.3; audio.play().then(() => { btn.innerText = "üîä"; musicPlaying = true; }).catch(e => console.log(e)); } else { audio.pause(); btn.innerText = "üîá"; musicPlaying = false; }
        }

        // --- GESTIONE STICKERS ---
        // Inserisci qui i nomi dei tuoi file (es. 1.jpg, 2.png, 18.jpg)
        const myStickers = ['1.jpg', '2.jpg', '4.jpg', '5.jpg', '6.jpg', '7.jpg', '8.jpg', '9.jpg', '10.jpg',
                            '11.jpg', '12.jpg', '13.jpg', '14.jpg', '15.jpg', '16.jpg', '17.jpg', '18.jpg', '19.jpg', '20.jpg',
                            '21.jpg', '22.jpg', '23.jpg', '24.jpg', '25.jpg', '26.jpg', '27.jpg', '28.jpg', '29.jpg', '30.jpg',
                            '31.jpg', '32.jpg', '33.jpg', '34.jpg', '35.jpg', '36.jpg', '37.jpg', '38.jpg', '39.jpg', '40.jpg',
                            '41.jpg', '42.jpg', '43.jpg', '44.jpg', '45.jpg', '46.jpg', '47.jpg', '48.jpg', '49.jpg', '50.jpg',
                            '51.jpg', '52.jpg', '53.jpg', '54.jpg', '55.jpg', '56.jpg', '57.jpg', '58.jpg', '59.jpg', '60.jpg',
                            '61.jpg', '62.jpg', '63.jpg', '64.jpg', '65.jpg', '66.jpg', '67.jpg', '68.jpg', '69.jpg', '70.jpg',
                            '71.jpg', '72.jpg', '73.jpg', '74.jpg', '75.jpg', '76.jpg', '77.jpg', '78.jpg', '79.jpg', '80.jpg',
                            '81.jpg', '82.jpg', '83.jpg', '84.jpg', '85.jpg', '86.jpg', '87.jpg', '88.jpg', '89.jpg', '90.jpg',
                            '91.jpg', '92.jpg', '93.jpg', '94.jpg', '95.jpg', '96.jpg', '97.jpg', '98.jpg', '99.jpg', '100.jpg',
                            '101.jpg', '102.jpg', '103.jpg', '104.jpg', '105.jpg', '106.jpg', '107.jpg', '108.jpg', '109.jpg', '110.jpg',
                            '111.jpg', '112.jpg', '113.jpg', '114.jpg', '115.jpg', '116.jpg', '117.jpg', '118.jpg', '119.jpg', '120.jpg',
                            '121.jpg', '122.jpg', '123.jpg', '124.jpg', '125.jpg', '126.jpg', '127.jpg', '128.jpg', '129.jpg', '130.jpg',
                            '131.jpg', '132.jpg', '133.jpg', '134.jpg', '135.jpg',
                            '1.webp', '2.webp', '3.webp', '4.webp', '5.webp', '6.webp', '7.webp', '8.webp', '9.webp', '10.webp',
                            '11.webp', '12.webp', '13.webp', '14.webp', '15.webp', '16.webp', '17.webp', '18.webp', '19.webp', '20.webp',
                            '21.webp'
         ]; // <-- AGGIORNA QUESTA LISTA CON I TUOI FILE!
        
        function toggleStickers() {
            const menu = document.getElementById('sticker-menu');
            if (menu.style.display === 'none') {
                menu.style.display = 'flex';
                // Carica gli sticker nel DOM solo la prima volta
                if (menu.innerHTML.trim() === '') {
                    myStickers.forEach(fileName => {
                        const img = document.createElement('img');
                        img.src = `/sticker/${fileName}`;
                        img.style.width = '60px';
                        img.style.height = '60px';
                        img.style.objectFit = 'contain';
                        img.style.cursor = 'pointer';
                        img.style.borderRadius = '5px';
                        img.style.backgroundColor = '#111';
                        img.onclick = () => sendSticker(fileName);
                        menu.appendChild(img);
                    });
                }
            } else {
                menu.style.display = 'none';
            }
        }

        function sendSticker(fileName) {
            socket.emit('sendChat', { text: fileName, type: 'sticker' });
            document.getElementById('sticker-menu').style.display = 'none'; // Chiudi il menu
        }
        // -------------------------

        socket.on('connect', () => { 
            myId = socket.id; 
            if(localStorage.getItem('bisca_username')) document.getElementById('username').value = localStorage.getItem('bisca_username');
            if(localStorage.getItem('bisca_room')) document.getElementById('roomname').value = localStorage.getItem('bisca_room');
        });

        socket.on('warning', (msg) => { alert(msg); });
        socket.on('errorMsg', (msg) => { alert(msg); resetToLogin(); });
        socket.on('forceKick', () => { alert("Sei stato rimosso per inattivit√†."); resetToLogin(); });

        function resetToLogin() {
            document.getElementById('game-area').style.display='none';
            document.getElementById('lobby').style.display='none';
            document.getElementById('chat-sidebar').style.display='none';
            document.getElementById('login').style.display='block';
            currentTableState = []; amISpectator = false; isBlindModeActive = false; currentBlindCards = [];
            document.querySelectorAll('.blind-card-display').forEach(e => e.remove());
            document.getElementById('my-hand').innerHTML = '';
            document.getElementById('seats-container').innerHTML = '';
            document.getElementById('asso-modal').style.display = 'none';
        }

        function changeRoom() { socket.emit('leaveRoom'); resetToLogin(); }
        function leaveGame() { if(confirm("Sei sicuro di voler abbandonare?")) { if (confirm("Vuoi rimanere nel tavolo come SPETTATORE?")) { socket.emit('leaveGame', { staySpectator: true }); } else { socket.emit('leaveGame', { staySpectator: false }); resetToLogin(); } } }
        function voteRestart() { socket.emit('voteRestart'); }
        function joinGameFromLobby() { socket.emit('switchRole', true); }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(txt) { 
                // Ora inviamo un oggetto indicando che √® testo
                socket.emit('sendChat', { text: txt, type: 'text' }); 
                input.value = ''; 
                input.focus(); 
            }
        }
        document.getElementById('chat-input').addEventListener("keypress", (e) => { if (e.key === "Enter") sendChat(); });

        function sendPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // Creiamo una tela (canvas) per rimpicciolire l'immagine
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600; // Larghezza massima (ottima per la chat)
                    const MAX_HEIGHT = 600;
                    let width = img.width;
                    let height = img.height;

                    // Calcolo delle proporzioni per non deformare la foto
                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convertiamo in formato testuale compresso (JPEG al 70% di qualit√†)
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    // Inviamo al server dicendo che √® una 'photo'
                    socket.emit('sendChat', { text: compressedDataUrl, type: 'photo' });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // Resettiamo l'input cos√¨ puoi mandare anche due foto di fila uguali
            event.target.value = '';
        }


        socket.on('chatMessage', (data) => {
            const chatBox = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = (data.id === myId) ? 'msg msg-mine' : 'msg msg-other';
            
            if(data.id === "SYS") { 
                div.style.background = "transparent"; div.style.color = "#d4af37"; div.style.textAlign = "center"; div.style.border = "1px solid #d4af37"; 
            }
            
            let content = (data.id !== "SYS" ? `<div class="msg-name">${data.name}</div>` : "");
            
            // Se √® uno sticker carica dalla cartella
            if (data.type === 'sticker') {
                content += `<img src="/sticker/${data.text}" style="width: 100px; height: auto; border-radius: 5px; margin-top: 4px; display: block;">`;
            } 
            // Se √® una foto scattata, carica i dati compressi inviati
            else if (data.type === 'photo') {
                content += `<img src="${data.text}" style="max-width: 100%; max-height: 250px; object-fit: contain; border-radius: 8px; margin-top: 5px; display: block; border: 1px solid #444;">`;
            } 
            // Altrimenti √® testo normale
            else {
                content += data.text; 
            }
            
            div.innerHTML = content;
            chatBox.appendChild(div); 
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        function renderCard(c, isHand, idx, isBack = false) {
            const div = document.createElement('div');
            div.className = isHand ? 'card hand-card' : 'card table-card';
            if (isBack) { div.className += ' card-back'; } else {
                const sMap = {'denari':'d', 'coppe':'c', 'spade':'s', 'bastoni':'b'};
                const imgSrc = `${CARTELLE_LOCALE}${c.value}${sMap[c.suit]}${ESTENSIONE}`;
                div.innerHTML = `<img src="${imgSrc}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="card-css" style="display:none;color:black;padding-top:20px;font-size:10px;">${c.value}<br>${c.suit}</div>`;
            }
            if(isHand) div.onclick = () => play(idx, c);
            return div;
        }

        function join() {
            const name = document.getElementById('username').value.trim();
            const roomName = document.getElementById('roomname').value.trim();
            if(!name || !roomName) return alert("Inserisci Nome e Stanza!");
            localStorage.setItem('bisca_username', name); localStorage.setItem('bisca_room', roomName);
            isBlindModeActive = false;
            socket.emit('join', { name: name, roomName: roomName });
            document.getElementById('login').style.display='none'; 
            document.getElementById('lobby').style.display='block';
            document.getElementById('chat-sidebar').style.display='flex';
            document.getElementById('room-title').innerText = "STANZA: " + roomName.toUpperCase();
            const audio = document.getElementById('bg-music');
            if(audio) { audio.volume = 0.3; audio.play().then(() => { document.getElementById('btn-music').style.display = "flex"; document.getElementById('btn-music').innerText = "üîä"; }).catch(e => console.log("Autoplay block")); }
        }
        
        function start() { const opts = { lives: document.getElementById('opt-lives').value, blindMode: document.getElementById('opt-blind').checked }; socket.emit('startGame', opts); }
        function togglePause() { socket.emit('togglePause'); }

        function play(idx, c) {
            if(!isMyTurn) return;
            if (c && c.suit === 'denari' && c.value === 1) { pendingCardIndex = idx; document.getElementById('asso-modal').style.display = 'flex'; return; }
            socket.emit('playCard', { cardIndex: idx, assoChoice: null });
        }

        function confirmAsso(choice) {
            if (pendingCardIndex !== null) { socket.emit('playCard', { cardIndex: pendingCardIndex, assoChoice: choice }); pendingCardIndex = null; }
            document.getElementById('asso-modal').style.display = 'none';
        }

        socket.on('backToLobby', () => {
            if (amISpectator) { const choice = confirm("La partita √® stata riavviata. Vuoi unirti alla prossima come giocatore?"); if (choice) { socket.emit('switchRole', true); } else { socket.emit('switchRole', false); } } else { alert("Partita finita/resettata! Ritorno alla Lobby."); }
            document.getElementById('game-area').style.display = 'none'; document.getElementById('lobby').style.display = 'block';
            isBlindModeActive = false; currentBlindCards = []; currentTableState = [];
            document.getElementById('my-hand').innerHTML = ''; document.getElementById('seats-container').innerHTML = '';
            document.querySelectorAll('.blind-card-display').forEach(e => e.remove());
        });

        socket.on('blindRoundStart', (allCards) => { isBlindModeActive = true; currentBlindCards = allCards; switchToGameView(); const handDiv = document.getElementById('my-hand'); handDiv.innerHTML=''; handDiv.appendChild(renderCard(null, true, 0, true)); });
        socket.on('blindRoundInfo', (allCards) => { isBlindModeActive = true; currentBlindCards = allCards; });
        socket.on('clearBlindCards', () => { isBlindModeActive = false; currentBlindCards = []; });

        socket.on('reconnectData', d => { 
            isBlindModeActive = d.isBlindModeActive || false; 
            switchToGameView(); 
            updateBonusUI(d.bonusInfo); 
            if(d.gameState==="PAUSED") document.getElementById('pause-overlay').style.display='flex'; 
            window.activeId = (d.players && d.players[d.currentPlayerIndex]) ? d.players[d.currentPlayerIndex].id : null;
            renderTable(d.players); 
            const handDiv = document.getElementById('my-hand'); 
            handDiv.innerHTML = '';
            if(d.hand && d.hand.length > 0) { d.hand.forEach((c, i) => handDiv.appendChild(renderCard(c, true, i, isBlindModeActive))); }
            handDiv.style.opacity = 1;
            updateTable(d.table); 
            updateTurn(d.isMyTurn, d.phase, d.roundCards); 
        });

        function switchToGameView() { document.getElementById('login').style.display='none'; document.getElementById('lobby').style.display='none'; document.getElementById('game-area').style.display='block'; document.getElementById('btn-pause').style.display='block'; document.getElementById('bonus-display').style.display='block'; document.getElementById('chat-sidebar').style.display='flex'; }

        socket.on('updatePlayers', d => {
            const list = d.list || d; const me = list.find(p => p.id === myId); if(me) amISpectator = me.isSpectator;
            document.getElementById('lobby-list').innerHTML = list.map(x=>x.name + (x.isSpectator ? " (üëÅÔ∏è)" : "")).join('<br>');
            if (d.isHost) { document.getElementById('host-controls').style.display = 'block'; document.getElementById('waiting-msg').style.display = 'none'; } else { document.getElementById('host-controls').style.display = 'none'; document.getElementById('waiting-msg').style.display = 'block'; }
            if (amISpectator) { document.getElementById('spectator-area').style.display = 'block'; } else { document.getElementById('spectator-area').style.display = 'none'; }
            renderTable(list); updateTable(currentTableState);
        });

        socket.on('updateBonus', d => updateBonusUI(d));
        function updateBonusUI(d) { const el = document.getElementById('bonus-display'); if (!d.used) { el.innerHTML = "BONUS: DISPONIBILE üü¢"; el.className = "bonus-active"; } else { el.innerHTML = `BONUS: USATO DA ${d.by ? d.by.toUpperCase() : '?'} üî¥`; el.className = "bonus-used"; } }

        socket.on('updateHand', h => {
            if (h.length > 1) { isBlindModeActive = false; currentBlindCards = []; document.querySelectorAll('.blind-card-display').forEach(e => e.remove()); }
            if(isBlindModeActive && h.length > 0) return; 
            switchToGameView(); const div = document.getElementById('my-hand'); div.innerHTML=''; h.forEach((c, i) => div.appendChild(renderCard(c, true, i)));
        });
        
        socket.on('tableUpdate', t => { currentTableState = t; updateTable(t); });
        socket.on('turnUpdate', d => { 
            window.activeId = d.playerId; 
            updateTurn(d.playerId===myId, d.phase, d.roundCards); 
            document.querySelectorAll('.player-seat').forEach(seat => {
                if(seat.getAttribute('data-playerid') === d.playerId) seat.classList.add('active-turn');
                else seat.classList.remove('active-turn');
            });
        });

        socket.on('gamePaused', p => document.getElementById('pause-overlay').style.display = p ? 'flex':'none');
        socket.on('statusMsg', m => document.getElementById('status-msg').innerHTML = m);
        socket.on('trickResult', m => { const el = document.getElementById('status-msg'); el.innerHTML=m; el.style.color='gold'; el.style.borderColor='gold'; setTimeout(()=> { el.style.color='#eee'; el.style.borderColor='#d4af37'; }, 2000); });
        socket.on('gameOver', m => { alert(m); });

        function updateTable(cards) { document.querySelectorAll('.played-card-slot').forEach(e=>e.innerHTML=''); cards.forEach(x => { const slot = document.getElementById('slot-'+x.playerId); if(slot) { const el = renderCard(x.card, false); if(x.isAssoHigh) el.innerHTML+=`<div class="asso-badge">${x.isAssoHigh?'A':'v'}</div>`; slot.appendChild(el); } }); }

        function updateTurn(isMine, phase, count) {
            isMyTurn = isMine; document.getElementById('my-hand').style.opacity = isMine ? 1 : 0.6; const c = document.getElementById('controls');
            if(amISpectator) { c.style.display='none'; return; }
            if(isMine && phase==='BIDDING') { 
                c.style.display='block'; const b=document.getElementById('bid-buttons'); b.innerHTML=''; 
                for(let i=0; i<=(count||5); i++) { 
                    let btn = document.createElement('button'); btn.innerText=i; 
                    btn.onclick = () => { socket.emit('placeBid', i); }; b.appendChild(btn); 
                } 
            } else c.style.display='none';
        }

        function renderTable(players) {
            const con = document.getElementById('seats-container'); con.innerHTML='';
            const myName = document.getElementById('username').value;
            let idx = players.findIndex(p=>p.name===myName); if(idx===-1) idx=0;
            const ordered = []; for(let i=0; i<players.length; i++) ordered.push(players[(idx+i)%players.length]);

            ordered.forEach((p, i) => {
                const deg = 90 + (i * (360/players.length)); const rad = deg * (Math.PI/180);
                const cx = 50 + 42*Math.cos(rad), cy = 50 + 40*Math.sin(rad); 
                
                const div = document.createElement('div');
                const deadClass = p.lives <= 0 && !p.isSpectator ? 'eliminated-player' : '';
                const activeClass = p.id===window.activeId ? 'active-turn' : '';
                
                div.className = `player-seat ${activeClass} ${deadClass}`;
                div.style.left=cx+'%'; div.style.top=cy+'%';
                div.setAttribute('data-playerid', p.id); 
                
                let stats = '';
                if (p.isSpectator) { stats = `<span style="color:#aaa;">SPETTATORE</span>`; } 
                else if (p.lives > 0) { let scommessa = p.lastBid !== null ? p.lastBid : '-'; let prese = p.lastWon; stats = `‚ù§Ô∏è${p.lives} <span style="color:#ffff00">D:${scommessa}</span> <span style="color:#00ff00">F:${prese}</span>`; } 
                else { stats = `üíÄ OUT`; }
                let dealerIcon = p.isDealer ? `<span style="color:gold; margin-left:5px;">üÉè</span>` : "";

                let blindHTML = '';
                if (isBlindModeActive && currentBlindCards.length > 0) { const blindInfo = currentBlindCards.find(c => c.id === p.id); if (blindInfo && blindInfo.card && p.id !== myId && p.lives > 0) { const sMap = {'denari':'d', 'coppe':'c', 'spade':'s', 'bastoni':'b'}; const src = `${CARTELLE_LOCALE}${blindInfo.card.value}${sMap[blindInfo.card.suit]}${ESTENSIONE}`; blindHTML = `<div class="blind-card-display"><img src="${src}"></div>`; } }
                
                let handCardsHTML = "";
                if(p.id !== myId && p.lives > 0 && p.handCount > 0) { handCardsHTML = `<div class="mini-card-container">`; for(let k=0; k<p.handCount; k++) { handCardsHTML += `<div class="mini-card"></div>`; } handCardsHTML += `</div>`; }
                
                // LAYOUT FIX: Box a sinistra SOLO se in alto AL CENTRO
                let infoStyle = "";
                if (cy < 25 && cx > 40 && cx < 60) {
                    infoStyle = "position: absolute; right: 105%; top: 50%; transform: translateY(-50%); margin-top: 0;";
                }

                div.innerHTML = `
                    <div class="avatar">${p.name[0]}</div> 
                    ${blindHTML} 
                    ${handCardsHTML} 
                    <div class="player-info" style="${infoStyle}">
                        <div style="color:#fff; font-weight:bold;">${p.name} ${dealerIcon}</div>${stats}
                    </div>`;

                const sx = 50 + 20*Math.cos(rad), sy = 50 + 20*Math.sin(rad);
                const slot = document.createElement('div'); slot.id='slot-'+p.id; slot.className='played-card-slot';
                slot.style.left=sx+'%'; slot.style.top=sy+'%';
                con.appendChild(div); con.appendChild(slot);
            });
        }
    </script>
        <script data-goatcounter="https://bisca.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>